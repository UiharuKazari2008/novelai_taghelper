<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>NAI Art Taghelper</title>
    <link rel="stylesheet" href="style.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"
            integrity="sha512-Eezs+g9Lq4TCCq0wae01s9PuNWzHYoCMkE97e2qdkYthpI0pzC3UGB03lgEHn2XM85hDOUF6qgqqszs+iXU4UA=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link href="vendor/fontawesome/css/all.min.css" rel="stylesheet" crossorigin="anonymous">
    <script src="vendor/fontawesome/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
    <script src="https://code.jquery.com/jquery-3.6.1.min.js"
            integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.hotkeys/list/jquery.hotkeys.min.js"
            integrity="sha512-njd096AjZyGuWOttOsHolCOFjq9Xg9txZTl6Pd7FOpwf1nyBDsOXpS1cd184l/EWy5ekDJZldDMQPs9bLCSAtQ=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
            crossorigin="anonymous"></script>
    <div class="container my-3">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">

        <div class="text center row">
            <div class="col-sm">
                <div id="simpleList" class="list-group col">
                </div>
            </div>
            <div class="col-sm">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <button type="button" class="add-el btn btn-dark" title="Append a tag to the list">
                            <i class="fa-light fa-plus-circle"></i>
                        </button>
                        <button type="button" class="copyclipboard btn btn-dark" title="Copy prompt to clipboard">
                            <i class="fa-light fa-clipboard"></i>
                        </button>
                        <button type="button" class="cleartags btn btn-dark" title="Clear all tags">
                            <i class="fa-light fa-trash-alt"></i>
                        </button>
                        <button type="button" class="savecontext btn btn-dark" title="Save context of the current tags">
                            <i class="fa-light fa-save"></i>
                        </button>
                    </div>
                    <input id="groupname" type="text" class="form-control" placeholder="default" aria-label=""
                           aria-describedby="basic-addon1">
                </div>
                <div class="row">
                    <div class="input-group mb-3 mt-2">
                        <div class="input-group-prepend">
                            <button id="readtext" class="btn border-dark-subtle  btn-outline-secondary" type="button"
                                    title="Import tags from text">
                                <i class="fa-light fa-arrow-left"></i>
                                </svg></button>
                        </div>
                        <input id="inputtxt" type="text" class="form-control" placeholder="" aria-label=""
                               aria-describedby="basic-addon1">
                    </div>
                </div>
                <div class="row">
                    <div id="group-names" class="list-group col">
                        <h3>
                            <span>No Saved Groups</span>
                        </h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <link href="css/style.css" rel="stylesheet" crossorigin="anonymous">
</body>

<script>
    const groupElementStart = `<div class="d-flex w-100 mx-2"><button type="button" class="btn border-dark-subtle  btn-outline-secondary btn-md rounded-0 tagbutton enablegroupbutton"><i class="fa-light fa-check-square"></i></button><button type="button" class="btn border-dark-subtle  btn-outline-secondary btn-md rounded-0 tagbutton replacegroupbutton"><i class="fa-light fa-arrow-left"></i></button><li class="list-group-item d-inline-flex groupitem w-100" contenteditable="false">`;
    const groupElementEnd = `</li><button type="button" class="btn border-dark-subtle  btn-outline-secondary btn-md rounded-0 tagbutton btn-red deletegroupbutton"><i class="fa-light fa-trash-alt"></i></button></div>`;

    const tagElementStart = `<div class="d-flex"><button type="button" class="btn border-dark-subtle  btn-outline-secondary btn-md rounded-0 tagbutton btn-red deletebutton"><i class="fa-light fa-times"></i></button><button type="button" class="btn border-dark-subtle  btn-outline-secondary btn-md rounded-0 tagbutton hidebtn"><i class="fa-light fa-eye-slash"></i></button><button type="button" class="btn border-dark-subtle  btn-outline-secondary btn-md rounded-0 tagbutton minusbutton"><i class="fa-light fa-minus"></i></button><li class="list-group-item d-inline-flex tagitem" ondblclick="this.contentEditable=true;this.className='list-group-item d-inline-flex tagitem';" onblur="this.contentEditable=false;this.className='list-group-item d-inline-flex tagitem';" contenteditable="false">`;
    const tagElementEnd = `</li><button type="button" class="btn border-dark-subtle  btn-outline-secondary tagbutton rounded-0 plusbutton"><i class="fa-light fa-plus"></i></button></div>`;

    loadSavedData();
    updateGroupList();

    let mysortable = Sortable.create(simpleList, {
        ghostClass: 'blue-background-class',
        animation: 150,
        removeOnSpill: true
    });

    function compileTags() {
        const text = getWorkspaceTags().join(", ");
        navigator.clipboard.writeText(text);
    }
    function getWorkspaceTags(all = false) {
        const lst = $('#simpleList');
        let array = [];
        array.push(...getEnabledGroups());
        for (let item of lst[0].children) {
            if (all || !item.classList.contains('parenttransparent')) {
                array.push(item.children[3].textContent.trim());
            }
        }
        return array
    }
    function tagNames(input) {
        function extractTagName(tags) {
            let res = []
            for (let element of tags) {
                let { name } = 0;
                if (element.includes(',')) {
                    res.push(...extractTagName(element.split(',').map(e => e.trim())));
                } else {
                    res.push(element.split('{').pop().split('[').pop().split('}')[0].split(']')[0].trim());
                }
            }
            return res
        }
        return extractTagName(input)
    }
    function decompileTags(txtvalue) {
        const regex = /(?:\{[^}]*\}|\[[^\]]*\]|[^,])+/g;
        const split = txtvalue.match(regex);

        return split.map(e => e.trim().replaceAll("_", " "))
    }
    function dedupTags(tags) {
        const current = tagNames(getWorkspaceTags(true));
        const removed = tags.filter(e => {
            if (e.includes(",")) {
                const t = tagNames(e);
                return t.filter(f => current.indexOf(f) === -1).length > 0
            }
            const name = e.split('{').pop().split('[').pop().split('}')[0].split(']')[0].trim()
            return current.indexOf(name) === -1
        });
        console.log(`Active: ${current.length} Added: ${removed.length}`)
        return removed;
    }
    function compileTagElement(split) {
        let text = ""
        for (let item of split) {
            if (item !== '') {
                text += '\n' + tagElementStart + item + tagElementEnd;
            }
        }
        return text;
    }
    async function loadTags() {
        let lst = $('#simpleList');
        let txt = $('#inputtxt');

        const txtValue = await navigator.clipboard.readText();
        const tags = decompileTags(txtValue);
        const text = compileTagElement(tags);

        txt[0].value = ""
        lst[0].innerHTML = text;
    }
    async function addTags() {
        let lst = $('#simpleList');
        let txt = $('#inputtxt');

        const txtValue = await navigator.clipboard.readText();
        const inputtags = decompileTags(txtValue);
        const tags = dedupTags(inputtags);
        const text = compileTagElement(tags);

        txt[0].value = ""
        lst[0].innerHTML += text;
    }
    function toggleDisable(tag, child) {
        tag.removeClass("parentopaque");
        tag.addClass('parenttransparent');

        child.removeClass('hidebtn');
        child.addClass('enablebtn');

        child[0].innerHTML = `<i class="fa-light fa-eye"></i>`
    }
    function toggleEnable(tag, child) {
        tag.removeClass("parenttransparent");
        tag.addClass('parentopaque');

        child.removeClass('enablebtn');
        child.addClass('hidebtn');

        child[0].innerHTML = `<i class="fa-light fa-eye-slash"></i>`
    }
    function toggleGroupDisable(tag, child) {
        child.removeClass('enablegroupbutton');
        child.addClass('disablegroupbutton');
    }
    function toggleGroupEnable(tag, child) {
        child.removeClass('disablegroupbutton');
        child.addClass('enablegroupbutton');
    }
    function lowerPriority(mstr) {
        if (mstr.startsWith('{') && mstr.endsWith('}')) {
            mstr = mstr.slice(1, -1);
        } else {
            mstr = '[' + mstr + ']';
        }
        return mstr.trim();
    }
    function increasePriority(mstr) {
        if (mstr.startsWith('[') && mstr.endsWith(']')) {
            mstr = mstr.slice(1, -1);
        } else {
            mstr = '{' + mstr + '}';
        }
        return mstr.trim();
    }
    // TODO: move this to a object...
    function saveContext() {
        let last = Object.keys(localStorage);
        let groupname = $('#groupname');
        let tags = $('#simpleList')[0];
        let group = (groupname[0].value && groupname[0].value.length > 0) ? groupname[0].value : "default";
        group = group.split(" ").join("_").trim();

        localStorage.setItem(`taggroup-${group}`, tags.innerHTML);
        let updated = Object.keys(localStorage);
        if (updated.filter(e => last.indexOf(e) === -1).length > 0)
            updateGroupList();
    }
    function loadSavedData() {
        let content = localStorage.getItem("taggroup-default")
        if (content) {
            $('#simpleList')[0].innerHTML = content;
        }
    }
    function updateGroupList() {
        let lst = $('#group-names');
        let list = Object.keys(localStorage);
        if (list && list.length > 0) {
            list = list
                .filter(e => e.startsWith("taggroup-"))
                .map(e => e.split('taggroup-').pop())
                .filter(e => e !== "default")
                .sort()
            if (list.length > 0) {
                lst[0].innerHTML = "";
                list.forEach(n => {
                    let name = n.split("_").join(" ").trim();
                    lst.append(`${groupElementStart}${name}${groupElementEnd}`);
                })
            }
        }
    }
    function getEnabledGroups() {
        const lst = $('#group-names .disablegroupbutton').parent()
        let list = Object.keys(localStorage);
        let array = [];
        if (list && list.length > 0) {
            list = list
                .filter(e => e.startsWith("taggroup-"))
                .map(e => e.split('taggroup-').pop())
                .filter(e => e !== "default")
            if (list.length > 0) {
                if (lst && lst.length > 0) {
                    lst
                        .map(n => {
                            const name = lst[n].children[2].innerText.split(" ").join("_").trim()
                            const data = localStorage.getItem('taggroup-' + name)
                            const dataList = $(data);
                            for (let item of dataList) {
                                if (item.children && !item.children[0].classList.contains('parenttransparent')) {
                                    array.push(item.children[3].textContent.trim());
                                }
                            }
                        })
                }
            }
        }
        return array;
    }
    function parseElemets(lst) {
        let res = []
        for (let item of lst[0].children) {
            let name, type, enabled, multiplier = 0;

            enabled = !item.classList.contains('parenttransparent')
            const element = item.children[3].textContent.trim()
            if (element.startsWith('{')) {
                type = 1;
                for (let char of element) {
                    if (char === '{' || char === '}') {
                        multiplier++;
                    }
                }
                multiplier /= 2; // Each pair of braces count as one multiplier
                name = element.slice(multiplier, -multiplier).split('{').pop().split('[').pop().split('}')[0].split(']')[0].trim();
            } else if (element.startsWith('[')) {
                type = 2;
                for (let char of element) {
                    if (char === '[' || char === ']') {
                        multiplier++;
                    }
                }
                multiplier /= 2; // Each pair of braces count as one multiplier
                name = element.slice(multiplier, -multiplier).split('{').pop().split('[').pop().split('}')[0].split(']')[0].trim();
            } else {
                type = 0;
                name = element.trim();
                multiplier = 0;
            }

            res.push({name, type, enabled, multiplier});
        }
        return res
    }

    $(document).on('click', '.copyclipboard', compileTags);
    $(document).bind('keydown', 'ctrl+c', compileTags);
    $(document).bind('keydown', 'ctrl+v', addTags);
    $(document).bind('keydown', 'ctrl+shift+v', loadTags);

    // Tag list actions
    $(document).on('click', '.add-el', function () {
        let lst = $('#simpleList');
        lst.append(`${tagElementStart}Tag${tagElementEnd}`);
    });
    $(document).on('click', '.plusbutton', function () {
        let parentDiv = $(this).parent();
        parentDiv[0].children[3].textContent = increasePriority(parentDiv[0].children[3].textContent);
    });
    $(document).on('click', '.minusbutton', function () {
        let parentDiv = $(this).parent();
        parentDiv[0].children[3].textContent = lowerPriority(parentDiv[0].children[3].textContent);
    });
    $(document).on('click', '.hidebtn', function () {
        toggleDisable($(this).parent(), $(this));
    });
    $(document).on('click', '.enablebtn', function () {
        toggleEnable($(this).parent(), $(this));
    });
    $(document).on('click', '.deletebutton', function () {
        $(this).parent().remove();
    });

    $(document).on('click', '.deletegroupbutton', function () {
        const group = `taggroup-${$(this).parent()[0].children[2].innerText.split(" ").join("_").trim()}`;
        localStorage.removeItem(group)
        $(this).parent().remove();
    });
    $(document).on('click', '.replacegroupbutton', function () {
        const rawname = $(this).parent()[0].children[2].innerText;
        const group = `taggroup-${rawname.split(" ").join("_").trim()}`;
        let name = rawname.split("_").join(" ").trim();
        const content = localStorage.getItem(group);
        if (content) {
            $('#simpleList')[0].innerHTML = content;
            $('#groupname')[0].value = name;
        }
    });
    $(document).on('click', '.enablegroupbutton', function () {
        toggleGroupDisable($(this).parent(), $(this));
    });
    $(document).on('click', '.disablegroupbutton', function () {
        toggleGroupEnable($(this).parent(), $(this));
    });

    $(document).on('click', '.cleartags', function () {
        let lst = $('#simpleList');
        lst[0].innerHTML = "";
    });
    $(document).on('click', '.savecontext', saveContext);
    $(document).on('click', '#readtext', function () {
        let lst = $('#simpleList');
        let txt = $('#inputtxt');
        const txtvalue = txt[0].value;
        txt[0].value = ""

        const inputtags = decompileTags(txtvalue);
        const tags = dedupTags(inputtags);
        const text = compileTagElement(tags);

        lst[0].innerHTML += text;
    });
</script>
