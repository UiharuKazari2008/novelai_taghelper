<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>NAI Art Taghelper</title>
    <link rel="stylesheet" href="style.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"
            integrity="sha512-Eezs+g9Lq4TCCq0wae01s9PuNWzHYoCMkE97e2qdkYthpI0pzC3UGB03lgEHn2XM85hDOUF6qgqqszs+iXU4UA=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link href="vendor/fontawesome/css/all.min.css" rel="stylesheet" crossorigin="anonymous">
    <script src="vendor/fontawesome/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
    <script src="https://code.jquery.com/jquery-3.6.1.min.js"
            integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.hotkeys/list/jquery.hotkeys.min.js"
            integrity="sha512-njd096AjZyGuWOttOsHolCOFjq9Xg9txZTl6Pd7FOpwf1nyBDsOXpS1cd184l/EWy5ekDJZldDMQPs9bLCSAtQ=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
            crossorigin="anonymous"></script>
    <nav class="navbar navbar-expand bg-body-tertiary nav-underline fixed-top">
        <div class="container-fluid">
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
                <div class="d-flex">
                    <div class="input-group me-2">
                        <input id="inputtxt" type="text" class="form-control" placeholder="Add Tags" aria-label=""
                               aria-describedby="basic-addon1">
                        <div class="input-group-append">
                            <button id="readtext" class="btn border-dark-subtle  btn-success" type="button"
                                    title="Import tags from text">
                                <i class="fa-light fa-plus-circle"></i>
                                </svg></button>
                        </div>
                    </div>
                </div>
                <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Guides
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" target="_blank" rel="noopener noreferrer" href="https://aituts.com/novelai-anime-prompt-techniques/">Getting Started</a></li>
                            <li><a class="dropdown-item" target="_blank" rel="noopener noreferrer" href="https://docs.novelai.net/image/tutorial-charactercreation.html">Character Creation</a></li>
                            <li><a class="dropdown-item" target="_blank" rel="noopener noreferrer" href="https://docs.novelai.net/image/tutorial-artstyles.html">Art Style</a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Tools
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" target="_blank" rel="noopener noreferrer" href="https://novelai-metadata-viewer.pages.dev/">Inspector</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" target="_blank" rel="noopener noreferrer" href="https://raideninfinity.pythonanywhere.com/naidv3_tag_search">Tag Search</a></li>
                            <li><a class="dropdown-item" target="_blank" rel="noopener noreferrer" href="https://huggingface.co/spaces/hysts/DeepDanbooru/">DeepDanbooru String</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" target="_blank" rel="noopener noreferrer" href="https://danbooru.donmai.us/tags">Anime - Tags</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" target="_blank" rel="noopener noreferrer" href="https://e621.net/wiki_pages/1671">Furry - Tag Groups</a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            Settings
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="importLocalStorage(); return false;">Import Groups</a></li>
                            <li><a class="dropdown-item" href="#" onclick="exportLocalStorage(); return false;">Export Groups</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="wipeLocalStorage(); return false;">Erase Settings</a></li>
                        </ul>
                    </li>
                </ul>
                <div class="d-flex ms-2">
                    <div class="input-group">
                        <div class="input-group-prepend">
                            <button type="button" class="copyclipboard btn btn-primary" title="Copy prompt to clipboard">
                                <i class="fa-light fa-clipboard"></i>
                            </button>
                            <button type="button" class="cleartags btn btn-danger" title="Clear all tags">
                                <i class="fa-light fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="d-flex align-items-center ms-2">
                    <span class="badge bg-white text-black font-monospace fs-6" id="tokencount">3</span>
                </div>
            </div>
        </div>
    </nav>

    <div class="container" style="margin-top: 6em; margin-bottom: 3em;">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">

        <div class="text center row">
            <div class="col-sm">
                <div id="simpleList" class="list-group col">
                </div>
            </div>
            <div class="col-sm">
                <div class="input-group mb-3">

                    <input id="groupname" type="text" class="form-control" placeholder="default" aria-label=""
                           aria-describedby="basic-addon1">
                    <div class="input-group-append d-flex">
                        <div class="dropdown" id="dropdownGroupTypeMenu">
                            <button class="btn btn-primary dropdown-toggle" type="button" id="dropdownGroupType" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="border-radius: 0!important; border-radius: 0 !important;">
                                Type
                            </button>
                            <div class="dropdown-menu" aria-labelledby="dropdownGroupType">
                                <a class="dropdown-item data-type-entry" href="#" data-type="000">
                                    <i class="fas fa-dot-circle pe-1" style="color: #ff5f5f;"></i>
                                    <span>Base / Quality</span>
                                </a>
                                <a class="dropdown-item data-type-entry" href="#" data-type="010">
                                    <i class="fas fa-dot-circle pe-1" style="color: #acff5f;"></i>
                                    <span>View Point</span>
                                </a>
                                <a class="dropdown-item data-type-entry" href="#" data-type="015">
                                    <i class="fas fa-dot-circle pe-1" style="color: #5f84ff;"></i>
                                    <span>Actions</span>
                                </a>
                                <a class="dropdown-item data-type-entry" href="#" data-type="020">
                                    <i class="fas fa-dot-circle pe-1" style="color: #ffda5f;"></i>
                                    <span>Character</span>
                                </a>
                                <a class="dropdown-item data-type-entry" href="#" data-type="030">
                                    <i class="fas fa-dot-circle pe-1" style="color: #8c5fff;"></i>
                                    <span>Clothes</span>
                                </a>
                                <a class="dropdown-item data-type-entry" href="#" data-type="040">
                                    <i class="fas fa-dot-circle pe-1" style="color: #ff975f;"></i>
                                    <span>Attribute</span>
                                </a>
                                <a class="dropdown-item data-type-entry active" href="#" data-type="050">
                                    <i class="fas fa-dot-circle pe-1" style="color: #5ffffa;"></i>
                                    <span>General</span>
                                </a>
                                <a class="dropdown-item data-type-entry" href="#" data-type="060">
                                    <i class="fas fa-dot-circle pe-1" style="color: #ff5fba;"></i>
                                    <span>Scene</span>
                                </a>
                            </div>
                        </div>
                        <button type="button" class="savecontext btn btn-primary" style="border-top-left-radius: 0!important; border-bottom-left-radius: 0 !important;" title="Save context of the current tags">
                            <i class="fa-light fa-save"></i>
                        </button>
                    </div>
                </div>
                <div id="groupsAccordion">
                    <div class="card">
                        <div class="card-header p-0" id="baseTags">
                            <h5 class="mb-0">
                                <button class="btn  btn-link text-decoration-none" data-bs-toggle="collapse" data-bs-target="#collapseBaseTags" aria-expanded="true" aria-controls="collapseBaseTags">
                                    <i class="fas fa-dot-circle pe-1" style="color: #ff5f5f;"></i>
                                    <span class="">Base / Quality</span>
                                </button>
                            </h5>
                        </div>
                        <div id="collapseBaseTags" class="collapse show" aria-labelledby="baseTags" data-bs-parent="#accordion" data-type="000">
                            <div class="p-0 card-body">

                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class=" card-header p-0" id="viewPointTags">
                            <h5 class="mb-0">
                                <button class="btn  btn-link text-decoration-none collapsed" data-bs-toggle="collapse" data-bs-target="#collapseViewPointTags" aria-expanded="false" aria-controls="collapseViewPointTags">
                                    <i class="fas fa-dot-circle pe-1" style="color: #acff5f;"></i>
                                    <span>View Point</span>
                                </button>
                            </h5>
                        </div>
                        <div id="collapseViewPointTags" class="collapse" aria-labelledby="viewPointTags" data-bs-parent="#accordion" data-type="010">
                            <div class="p-0 card-body">

                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class=" card-header p-0" id="actionsTags">
                            <h5 class="mb-0">
                                <button class="btn  btn-link text-decoration-none collapsed" data-bs-toggle="collapse" data-bs-target="#collapseActionTags" aria-expanded="false" aria-controls="collapseActionTags">
                                    <i class="fas fa-dot-circle pe-1" style="color: #5f84ff;"></i>
                                    <span>Actions</span>
                                </button>
                            </h5>
                        </div>
                        <div id="collapseActionTags" class="collapse" aria-labelledby="actionsTags" data-bs-parent="#accordion" data-type="015">
                            <div class="p-0 card-body">

                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class=" card-header p-0" id="characterTags">
                            <h5 class="mb-0">
                                <button class="btn  btn-link text-decoration-none collapsed" data-bs-toggle="collapse" data-bs-target="#collapseCharacterTags" aria-expanded="false" aria-controls="collapseCharacterTags">
                                    <i class="fas fa-dot-circle pe-1" style="color: #ffda5f;"></i>
                                    <span>Character</span>
                                </button>
                            </h5>
                        </div>
                        <div id="collapseCharacterTags" class="collapse" aria-labelledby="characterTags" data-bs-parent="#accordion" data-type="020">
                            <div class="p-0 card-body">

                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class=" card-header p-0" id="clothesTags">
                            <h5 class="mb-0">
                                <button class="btn  btn-link text-decoration-none collapsed" data-bs-toggle="collapse" data-bs-target="#collapseClothesTags" aria-expanded="false" aria-controls="collapseClothesTags">
                                    <i class="fas fa-dot-circle pe-1" style="color: #8c5fff;"></i>
                                    <span>Clothes</span>
                                </button>
                            </h5>
                        </div>
                        <div id="collapseClothesTags" class="collapse" aria-labelledby="clothesTags" data-bs-parent="#accordion" data-type="030">
                            <div class="p-0 card-body">

                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class=" card-header p-0" id="attributeTags">
                            <h5 class="mb-0">
                                <button class="btn  btn-link text-decoration-none collapsed" data-bs-toggle="collapse" data-bs-target="#collapseAttributeTags" aria-expanded="false" aria-controls="collapseAttributeTags">
                                    <i class="fas fa-dot-circle pe-1" style="color: #ff975f;"></i>
                                    <span>Attribute</span>
                                </button>
                            </h5>
                        </div>
                        <div id="collapseAttributeTags" class="collapse" aria-labelledby="attributeTags" data-bs-parent="#accordion" data-type="040">
                            <div class="p-0 card-body">

                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class=" card-header p-0" id="generalTags">
                            <h5 class="mb-0">
                                <button class="btn  btn-link text-decoration-none collapsed" data-bs-toggle="collapse" data-bs-target="#collapseGeneralTags" aria-expanded="false" aria-controls="collapseGeneralTags">
                                    <i class="fas fa-dot-circle pe-1" style="color: #5ffffa;"></i>
                                    <span>General</span>
                                </button>
                            </h5>
                        </div>
                        <div id="collapseGeneralTags" class="collapse" aria-labelledby="generalTags" data-bs-parent="#accordion" data-type="050">
                            <div class="p-0 card-body">

                            </div>
                        </div>
                    </div>
                    <div class="card">
                        <div class=" card-header p-0" id="sceneTags">
                            <h5 class="mb-0">
                                <button class="btn  btn-link text-decoration-none collapsed" data-bs-toggle="collapse" data-bs-target="#collapseSceneTags" aria-expanded="false" aria-controls="collapseSceneTags">
                                    <i class="fas fa-dot-circle pe-1" style="color: #ff5fba;"></i>
                                    <span>Scene</span>
                                </button>
                            </h5>
                        </div>
                        <div id="collapseSceneTags" class="collapse" aria-labelledby="sceneTags" data-bs-parent="#accordion" data-type="060">
                            <div class="p-0 card-body">

                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <link href="css/style.css" rel="stylesheet" crossorigin="anonymous">
</body>

<script>
    function groupElement(en, name, int) {
        return `
<div class="d-flex w-100">
    <button type="button" class="btn border-dark-subtle  btn-outline-secondary btn-md rounded-0 tagbutton ${(en) ? 'disablegroupbutton' : 'enablegroupbutton'}">
        <i class="fa-light fa-check-square"></i>
    </button>
    <button type="button" class="btn border-dark-subtle  btn-outline-secondary btn-md rounded-0 tagbutton replacegroupbutton">
        <i class="fa-light fa-pen-to-square"></i>
    </button>
    <li class="list-group-item d-inline-flex groupitem w-100 align-items-center px-2 border" contenteditable="false">${name}</li>
    <button type="button" class="btn border-dark-subtle  btn-outline-secondary btn-md rounded-0 tagbutton grouplowerbutton">
        <i class="fa-light fa-minus"></i>
    </button>
    <li class="list-group-item d-inline-flex intensity align-items-center px-2 border justify-content-center ${(int && !isNaN(parseInt(int.toString()))) ? ("intensity-" + ((parseInt(int.toString()) >= 10) ? "10" : int.toString())) : ''}" contenteditable="false" style="min-width: 36px">${(int) ? int : '-'}</li>
    <button type="button" class="btn border-dark-subtle  btn-outline-secondary tagbutton rounded-0 groupaddbutton">
        <i class="fa-light fa-plus"></i>
    </button>
    <button type="button" class="btn border-dark-subtle  btn-outline-secondary btn-md rounded-0 tagbutton btn-red deletegroupbutton">
        <i class="fa-light fa-trash-alt"></i>
    </button></div>`
    }
    function tagElement(name) {
        return `
<div class="d-flex">
    <button type="button" class="btn border-dark-subtle  btn-outline-secondary btn-md rounded-0 tagbutton btn-red deletebutton">
        <i class="fa-light fa-times"></i>
    </button>
    <button type="button" class="btn border-dark-subtle  btn-outline-secondary btn-md rounded-0 tagbutton hidebtn">
        <i class="fa-light fa-eye-slash"></i>
    </button>
    <button type="button" class="btn border-dark-subtle  btn-outline-secondary btn-md rounded-0 tagbutton minusbutton">
        <i class="fa-light fa-minus"></i>
    </button>
    <li class="list-group-item d-inline-flex tagitem" ondblclick="this.contentEditable=true;this.className='list-group-item d-inline-flex tagitem';" onblur="this.contentEditable=false;this.className='list-group-item d-inline-flex tagitem';" contenteditable="false">${name}</li>
    <button type="button" class="btn border-dark-subtle  btn-outline-secondary tagbutton rounded-0 plusbutton">
        <i class="fa-light fa-plus"></i>
    </button>
</div>`
    }

    loadSavedData();

    let mysortable = Sortable.create(simpleList, {
        ghostClass: 'blue-background-class',
        animation: 150,
        removeOnSpill: true
    });

    function saveSettings() {
        const enabled_groups = $('#groupsAccordion .disablegroupbutton').parent();
        if (enabled_groups && enabled_groups.length > 0) {
            localStorage.setItem(`settings-groups`, JSON.stringify({
                enabled: enabled_groups
                    .map(n => {
                        return {
                            type: enabled_groups[n].parentNode.parentNode.attributes["data-type"].value,
                            name: enabled_groups[n].children[2].innerText.split(" ").join("_").trim(),
                            value: enabled_groups[n].children[4].innerText.trim()
                        }
                    })
            }));
        }
    }
    function compileTags() {
        let text = getWorkspaceTags(false).join(", ");
        //text = deduplicateTags(text);
        navigator.clipboard.writeText(text);
        saveSettings();
        updateTagCount();
    }
    function getWorkspaceTags(all = false) {
        const lst = $('#simpleList');
        let array = [];
        array.push(...getEnabledGroups(true));
        for (let item of lst[0].children) {
            if (all || !item.classList.contains('parenttransparent')) {
                array.push(item.children[3].textContent.trim());
            }
        }
        return array
    }
    function tagNames(input) {
        function extractTagName(tags) {
            let res = []
            for (let element of tags) {
                let { name } = 0;
                if (element.includes(',')) {
                    res.push(...extractTagName(element.split(',').map(e => e.trim())));
                } else {
                    res.push(element.split('{').pop().split('[').pop().split('}')[0].split(']')[0].trim());
                }
            }
            return res
        }
        return extractTagName(input)
    }
    function countTokens(input) {
        let count = 0;
        function extractTagName(tags) {
            let res = []
            for (let element of tags) {
                let { name } = 0;
                if (element.includes(',')) {
                    res.push(...extractTagName(element.split(',').map(e => e.trim())));
                } else {
                    res.push(element.split('{').pop().split('[').pop().split('}')[0].split(']')[0].trim());
                }
            }
            return res
        }
        return extractTagName(input)
    }
    function decompileTags(txtvalue) {
        const regex = /(?:\{[^}]*\}|\[[^\]]*\]|[^,])+/g;
        const split = txtvalue.match(regex);

        return split.map(e => e.trim().replaceAll("_", " "))
    }
    function dedupTags(tags) {
        const current = tagNames(getWorkspaceTags(true));
        const removed = tags.filter(e => {
            if (e.includes(",")) {
                const t = tagNames(e);
                return t.filter(f => current.indexOf(f) === -1).length > 0
            }
            const name = e.split('{').pop().split('[').pop().split('}')[0].split(']')[0].trim()
            return current.indexOf(name) === -1
        });
        console.log(`Active: ${current.length} Added: ${removed.length}`)
        return removed;
    }
    function deduplicateTags(input) {
        // Split the input string by ","
        let tags = input.split(',').map(tag => tag.trim());

        // Priority levels
        const priorityLevels = {
            '{': 3,
            '[': 1,
            '': 0,
        };

        // Function to get priority level of a tag
        const getPriorityLevel = (tag) => {
            if (tag.includes('{')) return 3;
            if (tag.includes('[')) return 1;
            return 0;
        };

        // Function to clean and normalize tags
        const cleanTag = (tag) => tag.replace(/[{}[\] ]+/g, '').trim();

        // Deduplicate tags
        let seenTags = new Set();
        let resultTags = [];

        for (let tag of tags) {
            const cleanedTag = cleanTag(tag);
            const priority = getPriorityLevel(tag);

            if (!seenTags.has(cleanedTag)) {
                seenTags.add(cleanedTag);
                resultTags.push({ tag, priority, originalIndex: resultTags.length });
            } else {
                // Find existing tag with same cleanedTag and compare priority
                for (let existingTag of resultTags) {
                    if (cleanTag(existingTag.tag) === cleanedTag) {
                        // Replace with higher priority or keep the same if priorities are equal
                        if (priority > existingTag.priority || (priority === existingTag.priority && existingTag.originalIndex > resultTags.length)) {
                            existingTag.tag = tag;
                            existingTag.priority = priority;
                        }
                        break;
                    }
                }
            }
        }

        // Sort by original index to maintain order
        resultTags.sort((a, b) => a.originalIndex - b.originalIndex);

        // Join tags back into a string
        return resultTags.map(tag => tag.tag).join(', ');
    }
    function compileTagElement(split) {
        let text = ""
        for (let item of split) {
            if (item !== '') {
                text += '\n' + tagElement(item);
            }
        }
        return text;
    }
    async function loadTags() {
        let lst = $('#simpleList');
        let txt = $('#inputtxt');

        const txtValue = await navigator.clipboard.readText();
        const tags = decompileTags(txtValue);
        const text = compileTagElement(tags);

        txt[0].value = ""
        lst[0].innerHTML = text;
        updateTagCount();
    }
    async function addTags() {
        let lst = $('#simpleList');
        let txt = $('#inputtxt');

        const txtValue = await navigator.clipboard.readText();
        const inputtags = decompileTags(txtValue);
        const tags = dedupTags(inputtags);
        const text = compileTagElement(tags);

        txt[0].value = ""
        lst[0].innerHTML += text;
        updateTagCount();
    }
    function toggleDisable(tag, child) {
        tag.removeClass("parentopaque");
        tag.addClass('parenttransparent');

        child.removeClass('hidebtn');
        child.addClass('enablebtn');

        child[0].innerHTML = `<i class="fa-light fa-eye"></i>`
    }
    function toggleEnable(tag, child) {
        tag.removeClass("parenttransparent");
        tag.addClass('parentopaque');

        child.removeClass('enablebtn');
        child.addClass('hidebtn');

        child[0].innerHTML = `<i class="fa-light fa-eye-slash"></i>`
    }
    function toggleGroupDisable(tag, child) {
        child.removeClass('enablegroupbutton');
        child.addClass('disablegroupbutton');
    }
    function toggleGroupEnable(tag, child) {
        child.removeClass('disablegroupbutton');
        child.addClass('enablegroupbutton');
    }
    function lowerPriority(mstr) {
        if (mstr.startsWith('{') && mstr.endsWith('}')) {
            mstr = mstr.slice(1, -1);
        } else {
            mstr = '[' + mstr + ']';
        }
        return mstr.trim();
    }
    function increasePriority(mstr) {
        if (mstr.startsWith('[') && mstr.endsWith(']')) {
            mstr = mstr.slice(1, -1);
        } else {
            mstr = '{' + mstr + '}';
        }
        return mstr.trim();
    }
    // TODO: move this to a object...
    function saveContext() {
        let last = Object.keys(localStorage);
        let groupname = $('#groupname');
        let tags = $('#simpleList')[0];
        const type = $("#dropdownGroupTypeMenu .active")[0].attributes["data-type"].value;
        let group = (groupname[0].value && groupname[0].value.length > 0) ? type + "-" + groupname[0].value : "default";
        group = group.split(" ").join("_").trim();

        localStorage.setItem(`taggroup-${group}`, tags.innerHTML);
        let updated = Object.keys(localStorage);
        if (updated.filter(e => last.indexOf(e) === -1).length > 0) {
            const enabled = localStorage.getItem(`settings-groups`);
            updateGroupList(enabled);
        }
    }
    function loadSavedData() {
        let content = localStorage.getItem("taggroup-default")
        if (content) {
            $('#simpleList')[0].innerHTML = content;
        }
        const enabled = localStorage.getItem(`settings-groups`);
        updateGroupList(enabled);
        updateTagCount();
    }
    function updateGroupList(enabled) {
        $("#collapseBaseTags .card-body")[0].innerHTML      = "";
        $("#collapseViewPointTags .card-body")[0].innerHTML = "";
        $("#collapseActionTags .card-body")[0].innerHTML = "";
        $("#collapseCharacterTags .card-body")[0].innerHTML = "";
        $("#collapseClothesTags .card-body")[0].innerHTML   = "";
        $("#collapseAttributeTags .card-body")[0].innerHTML = "";
        $("#collapseGeneralTags .card-body")[0].innerHTML   = "";
        $("#collapseSceneTags .card-body")[0].innerHTML     = "";

        let list = Object.keys(localStorage);
        const enlist = (enabled) ? Object.values((JSON.parse(enabled)).enabled) : undefined;
        if (list && list.length > 0) {
            list = list
                .filter(e => e.startsWith("taggroup-"))
                .map(e => e.split('taggroup-').pop())
                .filter(e => e !== "default")
                .sort()
            if (list.length > 0) {
                list.forEach(n => {
                    let htmlString;
                    let name = n.substring(4).split("_").join(" ").trim();
                    if (enabled && enlist.map(e => e.type + '-' + e.name).indexOf(n) !== -1) {
                        const multiplyer = enlist[enlist.map(e => e.type + '-' + e.name).indexOf(n)].value
                        htmlString = groupElement(true, name, multiplyer);
                    } else {
                        htmlString = groupElement(false, name);
                    }
                    if (n.startsWith("000")) {
                        $("#collapseBaseTags .card-body").append($(htmlString));
                    } else if (n.startsWith("010")) {
                        $("#collapseViewPointTags .card-body").append($(htmlString));
                    } else if (n.startsWith("015")) {
                        $("#collapseActionTags .card-body").append($(htmlString));
                    } else if (n.startsWith("020")) {
                        $("#collapseCharacterTags .card-body").append($(htmlString));
                    } else if (n.startsWith("030")) {
                        $("#collapseClothesTags .card-body").append($(htmlString));
                    } else if (n.startsWith("040")) {
                        $("#collapseAttributeTags .card-body").append($(htmlString));
                    } else if (n.startsWith("060")) {
                        $("#collapseSceneTags .card-body").append($(htmlString));
                    } else {
                        $("#collapseGeneralTags .card-body").append($(htmlString));
                    }
                })
            }
        }

        if ($("#collapseBaseTags .card-body")[0].children.length === 0) {
            $("#collapseBaseTags").parent().addClass('d-none');
        } else {
            $("#collapseBaseTags").parent().removeClass('d-none');
        }
        if ($("#collapseViewPointTags .card-body")[0].children.length === 0) {
            $("#collapseViewPointTags").parent().addClass('d-none');
        } else {
            $("#collapseViewPointTags").parent().removeClass('d-none');
        }
        if ($("#collapseActionTags .card-body")[0].children.length === 0) {
            $("#collapseActionTags").parent().addClass('d-none');
        } else {
            $("#collapseActionTags").parent().removeClass('d-none');
        }
        if ($("#collapseCharacterTags .card-body")[0].children.length === 0) {
            $("#collapseCharacterTags").parent().addClass('d-none');
        } else {
            $("#collapseCharacterTags").parent().removeClass('d-none');
        }
        if ($("#collapseClothesTags .card-body")[0].children.length === 0) {
            $("#collapseClothesTags").parent().addClass('d-none');
        } else {
            $("#collapseClothesTags").parent().removeClass('d-none');
        }
        if ($("#collapseAttributeTags .card-body")[0].children.length === 0) {
            $("#collapseAttributeTags").parent().addClass('d-none');
        } else {
            $("#collapseAttributeTags").parent().removeClass('d-none');
        }
        if ($("#collapseGeneralTags .card-body")[0].children.length === 0) {
            $("#collapseGeneralTags").parent().addClass('d-none');
        } else {
            $("#collapseGeneralTags").parent().removeClass('d-none');
        }
        if ($("#collapseSceneTags .card-body")[0].children.length === 0) {
            $("#collapseSceneTags").parent().addClass('d-none');
        } else {
            $("#collapseSceneTags").parent().removeClass('d-none');
        }
    }

    function getEnabledGroups() {
        const addPositiveMultiplayer = (str, num) => `{`.repeat(num) + str + `}`.repeat(num);
        const addNegativeMultiplayer = (str, num) => `[`.repeat(num) + str + `]`.repeat(num);

        const lst = $('#groupsAccordion .disablegroupbutton').parent()
        let list = Object.keys(localStorage);
        let groupname = $('#groupname');
        let group = (groupname[0].value && groupname[0].value.length > 0) ? groupname[0].value.split(" ").join("_").trim() : undefined;
        let array = [];
        if (list && list.length > 0) {
            list = list
                .filter(e => e.startsWith("taggroup-"))
                .map(e => e.split('taggroup-').pop())
                .filter(e => e !== "default" && e !== group)
                .sort()
            if (list.length > 0) {
                if (lst && lst.length > 0) {
                    lst
                        .map(n => {
                            const name = lst[n].children[2].innerText.split(" ").join("_").trim()
                            const type = lst[n].parentNode.parentNode.attributes["data-type"].value;
                            const intentity = lst[n].children[4].innerText.trim()
                            const data = localStorage.getItem('taggroup-' + type + '-' + name)
                            const dataList = $(data);
                            let temp = [];

                            for (let item of dataList) {
                                if (item.children && !item.children[0].classList.contains('parenttransparent')) {
                                    temp.push(item.children[3].textContent.trim());
                                }
                            }
                            if (intentity === '-') {
                                array.push(...temp);
                            } else {
                                if (intentity.includes('-') && intentity.length > 1) {
                                    array.push(addNegativeMultiplayer(' ' + temp.join(', ') + ' ', parseInt(intentity.replace('-', ''))))
                                } else {
                                    array.push(addPositiveMultiplayer(' ' + temp.join(', ') + ' ', parseInt(intentity)))
                                }
                            }
                        })
                }
            }
        }
        return array;
    }
    function parseElemets(lst) {
        let res = []
        for (let item of lst[0].children) {
            let name, type, enabled, multiplier = 0;

            enabled = !item.classList.contains('parenttransparent')
            const element = item.children[3].textContent.trim()
            if (element.startsWith('{')) {
                type = 1;
                for (let char of element) {
                    if (char === '{' || char === '}') {
                        multiplier++;
                    }
                }
                multiplier /= 2; // Each pair of braces count as one multiplier
                name = element.slice(multiplier, -multiplier).split('{').pop().split('[').pop().split('}')[0].split(']')[0].trim();
            } else if (element.startsWith('[')) {
                type = 2;
                for (let char of element) {
                    if (char === '[' || char === ']') {
                        multiplier++;
                    }
                }
                multiplier /= 2; // Each pair of braces count as one multiplier
                name = element.slice(multiplier, -multiplier).split('{').pop().split('[').pop().split('}')[0].split(']')[0].trim();
            } else {
                type = 0;
                name = element.trim();
                multiplier = 0;
            }

            res.push({name, type, enabled, multiplier});
        }
        return res
    }

    function updateTagCount() {
        const tagArr = tagNames(getWorkspaceTags(false));
        const tags = tagArr.join(' ').split(' ').length + tagArr.length
        $('#tokencount')[0].innerText = tags;
        if (tags >= 180) {
            $('#tokencount').addClass("bg-danger")
            $('#tokencount').addClass("text-white")
            $('#tokencount').removeClass("bg-white")
            $('#tokencount').removeClass("text-black")
        } else {
            $('#tokencount').addClass("bg-white")
            $('#tokencount').addClass("text-black")
            $('#tokencount').removeClass("bg-danger")
            $('#tokencount').removeClass("text-white")
        }
    }

    function updateIntensityColor(obj) {
        const intetag = Array.from(obj.classList).filter(e => e.startsWith("intensity"))[0]
        if (intetag)
            obj.classList.remove(intetag);
        if (obj.textContent !== "-") {
            const int = parseInt(obj.textContent);
            if (!isNaN(int)) {
                if (int >= 10) {
                    obj.classList.add("intensity-10")
                } else {
                    obj.classList.add("intensity-" + int.toString())
                }
            }
        }
    }

    $(document).on('click', '.copyclipboard', compileTags);
    $(document).bind('keydown', 'ctrl+c', () => {
        let focusedElement = document.activeElement;
        let isTextBox = focusedElement.tagName === 'INPUT' ||
            focusedElement.tagName === 'TEXTAREA' ||
            focusedElement.isContentEditable;

        if (!isTextBox)
            compileTags();
    });
    $(document).bind('keydown', 'ctrl+v', () => {
        let focusedElement = document.activeElement;
        let isTextBox = focusedElement.tagName === 'INPUT' ||
            focusedElement.tagName === 'TEXTAREA' ||
            focusedElement.isContentEditable;

        if (!isTextBox)
            addTags();
    });
    $(document).bind('keydown', 'ctrl+shift+v', () => {
        let focusedElement = document.activeElement;
        let isTextBox = focusedElement.tagName === 'INPUT' ||
            focusedElement.tagName === 'TEXTAREA' ||
            focusedElement.isContentEditable;

        if (!isTextBox)
            loadTags();
    });

    // Tag list actions
    $(document).on('click', '.plusbutton', function () {
        let parentDiv = $(this).parent();
        parentDiv[0].children[3].textContent = increasePriority(parentDiv[0].children[3].textContent);
    });
    $(document).on('click', '.minusbutton', function () {
        let parentDiv = $(this).parent();
        parentDiv[0].children[3].textContent = lowerPriority(parentDiv[0].children[3].textContent);
    });
    $(document).on('click', '.hidebtn', function () {
        toggleDisable($(this).parent(), $(this));
        updateTagCount();
    });
    $(document).on('click', '.enablebtn', function () {
        toggleEnable($(this).parent(), $(this));
        updateTagCount();
    });
    $(document).on('click', '.deletebutton', function () {
        $(this).parent().remove();
        updateTagCount();
    });

    $(document).on('click', '.deletegroupbutton', function () {
        const type = $(this).parent().parent().parent()[0].attributes["data-type"].value;
        const group = `taggroup-${type}-${$(this).parent()[0].children[2].innerText.split(" ").join("_").trim()}`;
        localStorage.removeItem(group)
        $(this).parent().remove();
    });
    $(document).on('click', '.replacegroupbutton', function () {
        const type = $(this).parent().parent().parent()[0].attributes["data-type"].value;
        const rawname = $(this).parent()[0].children[2].innerText;
        const group = `taggroup-${type}-${rawname.split(" ").join("_").trim()}`;
        let name = rawname.split("_").join(" ").trim();
        const content = localStorage.getItem(group);
        if (content) {
            $("#dropdownGroupTypeMenu .dropdown-item").removeClass('active');
            $(`#dropdownGroupTypeMenu .dropdown-item[data-type=${type}]`).addClass("active");
            $('#simpleList')[0].innerHTML = content;
            $('#groupname')[0].value = name;
            if ($("#dropdownGroupTypeMenu .active").length === 0) {
                $(`#dropdownGroupTypeMenu .dropdown-item[data-type=050]`).addClass("active");
            }
        }
        updateTagCount();
    });
    $(document).on('click', '.enablegroupbutton', function () {
        toggleGroupDisable($(this).parent(), $(this));
        updateTagCount();
    });
    $(document).on('click', '.disablegroupbutton', function () {
        toggleGroupEnable($(this).parent(), $(this));
        updateTagCount();
    });
    $(document).on('click', '.groupaddbutton', function () {
        let parentDiv = $(this).parent();
        parentDiv[0].children[4].textContent = ((c) => {
            if (c === '-1') {
                return '-'
            } else if (c === '-') {
                return '1'
            } else {
                let val = parseInt(c);
                val++
                return val;
            }
        })(parentDiv[0].children[4].textContent)
        updateIntensityColor(parentDiv[0].children[4]);
    });
    $(document).on('click', '.grouplowerbutton', function () {
        let parentDiv = $(this).parent();
        parentDiv[0].children[4].textContent = ((c) => {
            if (c === '-') {
                return '-1'
            } else if (c === '1') {
                return '-'
            } else {
                let val = parseInt(c);
                val--
                return val;
            }
        })(parentDiv[0].children[4].textContent)
        updateIntensityColor(parentDiv[0].children[4]);
    });
    $(document).on('click', '.data-type-entry', function () {
        $("#dropdownGroupTypeMenu .dropdown-item").removeClass('active');
        $(this)[0].classList.add('active');
    });

    $(document).on('click', '.cleartags', function () {
        let lst = $('#simpleList');
        lst[0].innerHTML = "";
        updateTagCount();
    });
    $(document).on('click', '.savecontext', saveContext);
    $(document).on('click', '#readtext', function () {
        let lst = $('#simpleList');
        let txt = $('#inputtxt');
        const txtvalue = txt[0].value;
        txt[0].value = ""

        const inputtags = decompileTags(txtvalue);
        const tags = dedupTags(inputtags);
        const text = compileTagElement(tags);

        lst[0].innerHTML += text;
    });
    document.getElementById('inputtxt').addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            event.preventDefault();
            let lst = $('#simpleList');
            let txt = $('#inputtxt');
            const txtvalue = txt[0].value;
            txt[0].value = ""

            const inputtags = decompileTags(txtvalue);
            const tags = dedupTags(inputtags);
            const text = compileTagElement(tags);

            lst[0].innerHTML += text;
        }
    });

    function myFunction() {
        // Your function logic here
        console.log('Enter key pressed, function triggered!');
    }


    function exportLocalStorage() {
        const data = JSON.stringify(localStorage);
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'localStorageExport.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
    function importLocalStorage() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'application/json';
        input.onchange = async event => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = event => {
                    const importedData = JSON.parse(event.target.result);
                    const replace = confirm('Do you want to replace the current localStorage data? Click "Cancel" to only import new items instead.');

                    for (const [key, value] of Object.entries(importedData)) {
                        if (replace) {
                            localStorage.setItem(key, value);
                        } else {
                            if (!localStorage.getItem(key)) {
                                localStorage.setItem(key, value);
                            }
                        }
                    }
                };
                reader.readAsText(file);
            }
        };
        input.click();
    }
    function wipeLocalStorage() {
        const ready = confirm('All date you have not exported will be lost forever!');
        if (ready) {
            localStorage.clear();
        }
    }

</script>
</html>
