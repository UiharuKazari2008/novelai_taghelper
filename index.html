<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>NAI Art Taghelper</title>
    <link rel="stylesheet" href="style.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"
            integrity="sha512-Eezs+g9Lq4TCCq0wae01s9PuNWzHYoCMkE97e2qdkYthpI0pzC3UGB03lgEHn2XM85hDOUF6qgqqszs+iXU4UA=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">
    <link href="vendor/fontawesome/css/all.min.css" rel="stylesheet" crossorigin="anonymous">
    <script src="vendor/fontawesome/js/all.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>
<body>
    <script src="https://code.jquery.com/jquery-3.6.1.min.js"
            integrity="sha256-o88AwQnZB+VDvE9tvIXrMQaPlFFSUTR+nldQm1LuPXQ=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.hotkeys/list/jquery.hotkeys.min.js"
            integrity="sha512-njd096AjZyGuWOttOsHolCOFjq9Xg9txZTl6Pd7FOpwf1nyBDsOXpS1cd184l/EWy5ekDJZldDMQPs9bLCSAtQ=="
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4"
            crossorigin="anonymous"></script>
    <div class="container mt-3">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"
              integrity="sha384-rbsA2VBKQhggwzxH7pPCaAqO46MgnOM80zW1RWuH61DGLwZJEdK2Kadq2F9CUG65" crossorigin="anonymous">

        <div class="text center row">
            <div class="col-sm">
                <div id="simpleList" class="list-group col">
                </div>
            </div>
            <div class="col-sm">
                <div class="input-group">
                    <div class="input-group-prepend">
                        <button type="button" class="add-el btn btn-light" title="Append a tag to the list">
                            <i class="fa-light fa-plus-circle"></i>
                        </button>
                        <button type="button" class="copyclipboard btn btn-light" title="Copy prompt to clipboard">
                            <i class="fa-light fa-clipboard"></i>
                        </button>
                        <button type="button" class="cleartags btn btn-light" title="Clear all tags">
                            <i class="fa-light fa-eraser"></i>
                        </button>
                        <button type="button" class="savecontext btn btn-light" title="Save context of the current tags">
                            <i class="fa-light fa-save"></i>
                        </button>
                    </div>
                    <input id="groupname" type="text" class="form-control" placeholder="default" aria-label=""
                           aria-describedby="basic-addon1">
                </div>
                <div class="row">
                    <div class="input-group mb-3 mt-2">
                        <div class="input-group-prepend">
                            <button id="readtext" class="btn btn-outline-secondary" type="button"
                                    title="Import tags from text">
                                <i class="fa-light fa-arrow-left"></i>
                                </svg></button>
                        </div>
                        <input id="inputtxt" type="text" class="form-control" placeholder="" aria-label=""
                               aria-describedby="basic-addon1">
                    </div>
                </div>
                <div class="row">
                    <div id="group-names" class="list-group col">
                        <h3>
                            <span>No Saved Groups</span>
                        </h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <link href="css/style.css" rel="stylesheet" crossorigin="anonymous">
</body>

<script>
    const groupElementStart = `<div class="d-flex w-100 mx-2"><button type="button" class="btn btn-outline-secondary btn-md rounded-0 tagbutton btn-red deletegroupbutton"><i class="fa-light fa-times"></i></button><button type="button" class="btn btn-outline-secondary btn-md rounded-0 tagbutton plusgroupbutton"><i class="fa-light fa-plus-square"></i></button><button type="button" class="btn btn-outline-secondary btn-md rounded-0 tagbutton replacegroupbutton"><i class="fa-light fa-arrow-left"></i></button><li class="list-group-item d-inline-flex groupitem w-100" contenteditable="false">`;
    const groupElementEnd = `</li></div>`;

    const tagElementStart = `<div class="d-flex"><button type="button" class="btn btn-outline-secondary btn-md rounded-0 tagbutton btn-red deletebutton"><i class="fa-light fa-times"></i></button><button type="button" class="btn btn-outline-secondary btn-md rounded-0 tagbutton hidebtn"><i class="fa-light fa-eye-slash"></i></button><button type="button" class="btn btn-outline-secondary btn-md rounded-0 tagbutton minusbutton"><i class="fa-light fa-minus-square"></i></button><li class="list-group-item d-inline-flex tagitem" ondblclick="this.contentEditable=true;this.className='list-group-item d-inline-flex tagitem';" onblur="this.contentEditable=false;this.className='list-group-item d-inline-flex tagitem';" contenteditable="false">`;
    const tagElementEnd = `</li><button type="button" class="btn btn-outline-secondary tagbutton rounded-0 plusbutton"><i class="fa-light fa-plus-square"></i></button></div>`;

    loadSavedData();
    updateGroupList();

    let mysortable = Sortable.create(simpleList, {
        ghostClass: 'blue-background-class',
        animation: 150,
        removeOnSpill: true
    });

    function compileTags() {
        const lst = $('#simpleList');
        let text = "";

        for (let item of lst[0].children) {
            if (!item.classList.contains('parenttransparent')) {
                text += item.children[3].textContent.trim() + ', ';
            }
        }
        navigator.clipboard.writeText(text);
    }
    function decompileTags(txtvalue) {
        const split = txtvalue.split(',')
        let text = "";

        for (let item of split) {
            if (item.charAt(0) === ' ') {
                item = item.substring(1);
            }
            if (item.substring(item.length - 1) === ' ') {
                item = item.substring(0, item.length - 1);
            }
            item = item.replaceAll('_', ' ');

            if (item !== '') {
                text += '\n' + tagElementStart + item + tagElementEnd;
            }
        }
        return text
    }
    async function loadTags() {
        let lst = $('#simpleList');
        let txt = $('#inputtxt');

        const txtValue = await navigator.clipboard.readText();
        const text = decompileTags(txtValue);
        txt[0].value = ""

        lst[0].innerHTML = text;
    }
    async function addTags() {
        let lst = $('#simpleList');
        let txt = $('#inputtxt');

        const txtValue = await navigator.clipboard.readText();
        const text = decompileTags(txtValue);
        txt[0].value = ""

        lst[0].innerHTML += text;
    }
    function toggleDisable(tag, child) {
        tag.removeClass("parentopaque");
        tag.addClass('parenttransparent');

        child.removeClass('hidebtn');
        child.addClass('enablebtn');

        child[0].innerHTML = `<i class="fa-light fa-eye"></i>`
    }
    function toggleEnable(tag, child) {
        tag.removeClass("parenttransparent");
        tag.addClass('parentopaque');

        child.removeClass('enablebtn');
        child.addClass('hidebtn');

        child[0].innerHTML = `<i class="fa-light fa-eye-slash"></i>`
    }
    function lowerPriority(mstr) {
        if (mstr.startsWith('{') && mstr.endsWith('}')) {
            mstr = mstr.slice(1, -1);
        } else {
            mstr = '[' + mstr + ']';
        }
        return mstr.trim();
    }
    function increasePriority(mstr) {
        if (mstr.startsWith('[') && mstr.endsWith(']')) {
            mstr = mstr.slice(1, -1);
        } else {
            mstr = '{' + mstr + '}';
        }
        return mstr.trim();
    }
    // TODO: WTF is this, move this to a object...
    function saveContext() {
        let groupname = $('#groupname');
        let tags = $('#simpleList')[0];
        let group = (groupname[0].value && groupname[0].value.length > 0) ? groupname[0].value : "default";
        group = group.split(" ").join("_").trim();

        localStorage.setItem(`taggroup-${group}`, tags.innerHTML);
        updateGroupList();
    }
    function loadSavedData() {
        let content = localStorage.getItem("taggroup-default")
        if (content) {
            $('#simpleList')[0].innerHTML = content;
        }
    }
    function updateGroupList() {
        let lst = $('#group-names');
        let list = Object.keys(localStorage);
        if (list && list.length > 0) {
            list = list
                .filter(e => e.startsWith("taggroup-"))
                .map(e => e.split('taggroup-').pop())
                .filter(e => e !== "default")
            if (list.length > 0) {
                lst[0].innerHTML = "";
                list.forEach(n => {
                    let name = n.split(" ").join("_").trim();
                    lst.append(`${groupElementStart}${name}${groupElementEnd}`);
                })
            }
        }
    }

    $(document).on('click', '.copyclipboard', compileTags);
    $(document).bind('keydown', 'ctrl+c', compileTags);
    $(document).bind('keydown', 'ctrl+v', addTags);
    $(document).bind('keydown', 'ctrl+shift+v', loadTags);

    // Tag list actions
    $(document).on('click', '.add-el', function () {
        let lst = $('#simpleList');
        lst.append(`${tagElementStart}Tag${tagElementEnd}`);
    });
    $(document).on('click', '.plusbutton', function () {
        let parentDiv = $(this).parent();
        parentDiv[0].children[3].textContent = increasePriority(parentDiv[0].children[3].textContent);
    });
    $(document).on('click', '.minusbutton', function () {
        let parentDiv = $(this).parent();
        parentDiv[0].children[3].textContent = lowerPriority(parentDiv[0].children[3].textContent);
    });
    $(document).on('click', '.hidebtn', function () {
        toggleDisable($(this).parent(), $(this));
    });
    $(document).on('click', '.enablebtn', function () {
        toggleEnable($(this).parent(), $(this));
    });
    $(document).on('click', '.deletebutton', function () {
        $(this).parent().remove();
    });

    $(document).on('click', '.deletegroupbutton', function () {
        const group = `taggroup-${$(this).parent()[0].children[3].innerText}`;
        localStorage.removeItem(group)
        $(this).parent().remove();
    });
    $(document).on('click', '.replacegroupbutton', function () {
        const rawname = $(this).parent()[0].children[3].innerText;
        const group = `taggroup-${rawname}`;
        let name = rawname.split(" ").join("_").trim();
        const content = localStorage.getItem(group);
        if (content) {
            $('#simpleList')[0].innerHTML = content;
            $('#groupname')[0].value = name;
        }
    });
    $(document).on('click', '.plusgroupbutton', function () {
        const group = `taggroup-${$(this).parent()[0].children[3].innerText}`;
        const content = localStorage.getItem(group);
        if (content) {
            const items = $(content);
            items.map(it => {
                $('#simpleList')[0].append(items[it]);
            })
        }
    });

    $(document).on('click', '.cleartags', function () {
        let lst = $('#simpleList');
        lst[0].innerHTML = "";
    });
    $(document).on('click', '.savecontext', saveContext);
    $(document).on('click', '#readtext', function () {
        let lst = $('#simpleList');
        let txt = $('#inputtxt');
        const txtvalue = txt[0].value;
        txt[0].value = ""

        const text = decompileTags(txtvalue);
        lst[0].innerHTML += text;
    });
</script>
